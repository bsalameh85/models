<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>مديرية صحة محافظة مادبا نظام ادارة النماذج</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f0f4f8;
      margin: 0; padding: 0;
      direction: rtl;
    }
    header {
      display: flex; /* استعادة الـ flexbox للتحكم في التوزيع */
      justify-content: space-between; /* توزيع العناصر على الجانبين */
      align-items: center; /* توسيط عمودي */
      padding: 15px 20px;
      background: #1e3a8a;
      color: white;
      text-align: center; /* يبقى هنا للتوسيط العام للمحتوى */
    }
    #dateTime {
      font-size: 16px;
      direction: ltr; /* لضمان عرض التاريخ والوقت بشكل صحيح */
    }
    #headerTitle {
      font-size: 24px;
      flex-grow: 1; /* يسمح للعنصر بأخذ المساحة المتاحة وتوسيطه */
      text-align: center; /* توسيط العنوان نفسه */
    }
    main {
      max-width: 900px;
      margin: 30px auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px #ccc;
    }
    label {
      display: block;
      margin: 10px 0 5px;
    }
    input[type=text] {
      width: 100%;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }
    button {
      margin-top: 15px;
      background-color: #2563eb;
      color: white;
      border: none;
      padding: 12px 25px;
      font-size: 16px;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.3s;
      min-width: 100px;
    }
    button:hover {
      background-color: #1e40af;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 25px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 12px;
      text-align: center;
    }
    th {
      background-color: #e5e7eb;
    }
    .actionBtn {
      min-width: 100px;
      padding: 10px 15px;
      font-size: 14px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      color: white;
      transition: background-color 0.3s;
      margin: 0;
    }
    .viewBtn {
      background-color: #2563eb;
    }
    .viewBtn:hover {
      background-color: #1e40af;
    }
    iframe {
      width: 100%;
      height: 600px;
      border: none;
      margin-top: 20px;
      border-radius: 6px;
      box-shadow: 0 0 8px #aaa;
      display: none;
    }
    nav { /* تنسيقات شريط التنقل للمستعلم */
      text-align: center;
      margin-bottom: 20px;
    }
    nav a {
      color: #1e3a8a;
      text-decoration: none;
      font-weight: bold;
      font-size: 18px;
      border: 2px solid #1e3a8a;
      padding: 6px 12px;
      border-radius: 6px;
      transition: background-color 0.3s, color 0.3s;
    }
    nav a:hover {
      background-color: #1e3a8a;
      color: white;
    }
  </style>
</head>
<body>
<header>
  <div id="dateTime"></div> <div id="headerTitle">
    مديرية صحة محافظة مادبا<br>
    نظام ادارة النماذج
  </div>
</header>
<main>
<nav>
  <a href="admin.html">لوحة تحكم المدير ⚙️</a>
</nav>
<section id="searchSection">
  <label for="filterKeyword">بحث بالكلمة المفتاحية في الاسم</label>
  <input type="text" id="filterKeyword" placeholder="أدخل كلمة للبحث" />
  <button id="searchBtn">بحث</button>
</section>

<section id="resultsSection">
  <table id="modelsTable">
    <thead>
      <tr>
        <th>اسم النموذج</th>
        <th>الإجراءات</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <iframe id="pdfViewer"></iframe>
</section>
</main>

<script async defer src="https://apis.google.com/js/api.js"></script>
<script src="https://accounts.google.com/gsi/client"></script>

<script>
  // Google API & GIS configuration
  const CLIENT_ID = '877200657875-b5qcv791tdespl57eof12tfl92q01hbm.apps.googleusercontent.com';
  // في واجهة المستعلم، نحتاج فقط لقراءة بيانات التعريف للملفات (metadata) وليس صلاحيات التعديل أو الرفع
  const SCOPES = 'https://www.googleapis.com/auth/drive.metadata.readonly';

  const DESTINATION_FOLDER_ID = '1pr2L9RzJ5kI5ybA94EOZYuy1WFtoia-8';

  let gapiInited = false;
  let gisInited = false;
  let tokenClient;
  let allModels = []; // لتخزين جميع النماذج بعد جلبها من درايف

  function handleClientLoad() {
    gapi.load('client', intializeGapiClient);
    google.accounts.id.initialize({
      client_id: CLIENT_ID,
      callback: () => {},
    });
    if (typeof google !== 'undefined' && google.accounts && google.accounts.oauth2) {
      onLoadGis();
    } else {
      console.log('Waiting for google.accounts.oauth2 to load...');
      setTimeout(handleClientLoad, 200);
    }
  }

  async function intializeGapiClient() {
    await gapi.client.init({
      discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
    });
    gapiInited = true;
    console.log('gapi client initialized for user view');
    // جلب النماذج وعرضها فوراً عند التحميل
    await fetchAndRenderModels();
  }

  function onLoadGis() {
    tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: CLIENT_ID,
      scope: SCOPES,
      callback: '',
    });
    gisInited = true;
    console.log('GIS client initialized for user view');
  }

  window.onload = handleClientLoad;

  // هذه الوظيفة تم تعديلها لجلب الملفات من Google Drive
  async function getAllModelsFromDrive() {
    try {
      // محاولة المصادقة بصمت عند تحميل الصفحة لجلب القائمة
      await authenticate(false); // false يعني لا تظهر popup إلا إذا فشل الصمت تمامًا

      const response = await gapi.client.drive.files.list({
        q: `'${DESTINATION_FOLDER_ID}' in parents and mimeType='application/pdf' and trashed=false`,
        fields: 'files(id, name, createdTime)',
        pageSize: 100
      });

      const files = response.result.files;
      return files.map(file => ({
        id: file.createdTime ? new Date(file.createdTime).getTime() : Date.now(),
        name: file.name.replace(/\.pdf$/i, ''),
        googleDriveFileId: file.id
      }));
    } catch (error) {
      console.error('Error fetching files from Google Drive (silent auth):', error);
      // لا تعرض رسالة خطأ للمستخدم في واجهة المستعلم عادةً عند فشل المصادقة الصامتة
      // بل اعرض جدولاً فارغاً أو رسالة "يرجى المصادقة لعرض الملفات"
      renderFilteredTable([]); // عرض جدول فارغ
      return [];
    }
  }

  // Authentication function - تم تعديلها لتقبل معلم لتحديد نوع الـ prompt
  async function authenticate(forcePrompt = false) {
    return new Promise((resolve, reject) => {
      if (!gapiInited || !gisInited) {
        console.error('Google API client or GIS not loaded yet. Retrying in 1 second...');
        setTimeout(() => authenticate(forcePrompt).then(resolve).catch(reject), 1000);
        return;
      }

      tokenClient.callback = (resp) => {
        if (resp.error) {
          console.error('Authentication error:', resp.error);
          reject(resp.error);
        } else {
          console.log('Authentication successful:', resp);
          resolve();
        }
      };

      const token = gapi.client.getToken();
      if (token === null || token.expires_at < Date.now() + 60000) {
        console.log('Requesting new access token...');
        if (forcePrompt) {
          tokenClient.requestAccessToken({ prompt: 'consent' }); // إظهار نافذة الموافقة
        } else {
          tokenClient.requestAccessToken({ prompt: 'none' }); // محاولة بصمت
        }
      } else {
        console.log('Using existing access token.');
        resolve();
      }
    });
  }

  // وظيفة لجلب وعرض النماذج
  async function fetchAndRenderModels() {
    allModels = await getAllModelsFromDrive(); // جلب جميع النماذج وتخزينها
    renderFilteredTable(''); // عرض كل النماذج في البداية
  }

  // وظيفة لعرض الجدول بناءً على البحث
  function renderFilteredTable(searchText) {
    const tbody = document.querySelector('#modelsTable tbody');
    tbody.innerHTML = '';
    const filteredModels = allModels.filter(model =>
      model.name.toLowerCase().includes(searchText.toLowerCase())
    );

    if (filteredModels.length === 0) {
      tbody.innerHTML = `<tr><td colspan="2">لا يوجد نماذج مطابقة.</td></tr>`;
      document.getElementById('pdfViewer').style.display = 'none';
      return;
    }

    filteredModels.forEach(model => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${escapeHtml(model.name)}</td>
        <td><button class="actionBtn viewBtn" data-googledriveid="${model.googleDriveFileId || ''}">عرض</button></td>
      `;
      tbody.appendChild(tr);
    });
  }

  // Helper functions
  function escapeHtml(text) {
    return text.replace(/[&<>"']/g, m => ({
      '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
    })[m]);
  }

  // Search input event listener
  document.getElementById('filterKeyword').addEventListener('input', e => {
    renderFilteredTable(e.target.value.trim());
  });

  document.getElementById('searchBtn').addEventListener('click', () => {
    renderFilteredTable(document.getElementById('filterKeyword').value.trim());
  });
  
  document.getElementById('filterKeyword').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      renderFilteredTable(document.getElementById('filterKeyword').value.trim());
    }
  });

  // View Button Event Listener
  document.querySelector('#modelsTable tbody').addEventListener('click', async e => {
    if (e.target.classList.contains('viewBtn')) {
      const googleDriveFileId = e.target.dataset.googledriveid;

      if (!googleDriveFileId) {
        console.error('No Google Drive File ID for this model.');
        return;
      }
      try {
        // عند النقر على عرض، قم بالمصادقة مع إظهار الـ popup إذا لزم الأمر
        await authenticate(true); // true يعني: اظهر نافذة الموافقة إذا كانت مطلوبة

        const iframe = document.getElementById('pdfViewer');
        const accessToken = gapi.client.getToken().access_token;
        if (!accessToken) {
          console.error('Access token not available for viewing.');
          return;
        }
        iframe.src = `https://docs.google.com/viewer?url=https://www.googleapis.com/drive/v3/files/${googleDriveFileId}?alt=media&access_token=${accessToken}&embedded=true`;
        iframe.style.display = 'block';
        iframe.scrollIntoView({ behavior: "smooth" });

      } catch (err) {
        console.error('Error viewing file from Google Drive:', err);
        alert('تعذر عرض الملف. يرجى التأكد من اتصالك بالإنترنت ومنح الصلاحيات اللازمة.'); // رسالة للمستخدم هنا
      }
    }
  });

  // تحديث التاريخ والوقت كل ثانية (أعيدت إضافتها)
  function updateDateTime() {
    const dateTimeDiv = document.getElementById('dateTime');
    const now = new Date();

    const optionsDate = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
    const optionsTime = { hour: '2-digit', minute: '2-digit', second: '2-digit' };

    const formattedDate = now.toLocaleDateString('ar-EG', optionsDate);
    const formattedTime = now.toLocaleTimeString('ar-EG', optionsTime);

    dateTimeDiv.textContent = `${formattedDate} - ${formattedTime}`;
  }

  setInterval(updateDateTime, 1000);
  updateDateTime(); // Initial call to display immediately
</script>
</body>
</html>
