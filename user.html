<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>مديرية صحة محافظة مادبا نظام ادارة النماذج</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f0f4f8;
      margin: 0; padding: 0;
      direction: rtl;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 20px;
      background: #1e3a8a;
      color: white;
      text-align: center;
    }
    #dateTime {
      font-size: 16px;
      direction: ltr;
    }
    #headerTitle {
      font-size: 24px;
      flex-grow: 1;
      text-align: center;
    }
    main {
      max-width: 900px;
      margin: 30px auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px #ccc;
    }
    label {
      display: block;
      margin: 10px 0 5px;
    }
    input[type=text] {
      width: 100%;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }
    button {
      margin-top: 15px;
      background-color: #2563eb;
      color: white;
      border: none;
      padding: 12px 25px;
      font-size: 16px;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.3s;
      min-width: 100px;
    }
    button:hover {
      background-color: #1e40af;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 25px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 12px;
      text-align: center;
    }
    th {
      background-color: #e5e7eb;
    }
    .actionBtn {
      min-width: 100px; /* Reverted to wider width for single button */
      padding: 10px 15px; /* Reverted padding */
      font-size: 14px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      color: white;
      transition: background-color 0.3s;
      margin: 0; /* Removed extra margin */
    }
    .viewBtn {
      background-color: #2563eb;
    }
    .viewBtn:hover {
      background-color: #1e40af;
    }
    /* Removed .printBtn styles */
    iframe {
      width: 100%;
      height: 600px;
      border: none;
      margin-top: 20px;
      border-radius: 6px;
      box-shadow: 0 0 8px #aaa;
      display: none;
    }
  </style>
</head>
<body>
<header>
  <div id="dateTime"></div>
  <div id="headerTitle">
    مديرية صحة محافظة مادبا<br>
    نظام ادارة النماذج
  </div>
</header>

<main>
<section id="searchSection">
  <label for="filterKeyword">بحث بالكلمة المفتاحية في الاسم</label>
  <input type="text" id="filterKeyword" placeholder="أدخل كلمة للبحث" />
  <button id="searchBtn">بحث</button>
</section>

<section id="resultsSection">
  <table id="modelsTable">
    <thead>
      <tr>
        <th>اسم النموذج</th>
        <th>الإجراءات</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <iframe id="pdfViewer"></iframe>
</section>
</main>

<script>
  const DB_NAME = 'PDFModelsDB';
  const DB_VERSION = 1;
  const STORE_NAME = 'models';
  let db;

  // Function to open the IndexedDB
  function openDB() {
    return new Promise((resolve, reject) => {
      const request = indexedDB.open(DB_NAME, DB_VERSION);
      request.onupgradeneeded = event => {
        const db = event.target.result;
        if (!db.objectStoreNames.contains(STORE_NAME)) {
          db.createObjectStore(STORE_NAME, { keyPath: 'id' });
        }
      };
      request.onsuccess = event => {
        db = event.target.result;
        resolve(db);
      };
      request.onerror = event => {
        reject(event.target.error);
      };
    });
  }

  // Function to get all models from IndexedDB
  function getAllModels() {
    return new Promise((resolve, reject) => {
      if (!db) {
        reject('Database not open.');
        return;
      }
      const tx = db.transaction(STORE_NAME, 'readonly');
      const store = tx.objectStore(STORE_NAME);
      const request = store.getAll();
      request.onsuccess = e => resolve(e.target.result);
      request.onerror = e => reject(e.target.error);
    });
  }

  // تصفية النماذج بناءً على الكلمة المفتاحية
  function filterModels(models, keyword) {
    if (!keyword) return models;
    const lowerCaseKeyword = keyword.toLowerCase();
    return models.filter(m => m.name.toLowerCase().includes(lowerCaseKeyword));
  }

  // عرض النتائج في الجدول
  function renderTable(models) {
    const tbody = document.querySelector('#modelsTable tbody');
    tbody.innerHTML = '';

    if (models.length === 0) {
      tbody.innerHTML = `<tr><td colspan="2">لا توجد نتائج مطابقة لمعايير البحث.</td></tr>`;
      return;
    }

    models.forEach(model => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${model.name}</td>
        <td>
          <button class="actionBtn viewBtn" data-id="${model.id}">عرض</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  // البحث و عرض النتائج
  async function searchAndRender() {
    const keyword = document.getElementById('filterKeyword').value.trim();

    try {
      const allModels = await getAllModels();
      const filtered = filterModels(allModels, keyword);
      renderTable(filtered);
      hidePdfViewer();
    } catch (error) {
      console.error('Error fetching or rendering models:', error);
      alert('حدث خطأ أثناء جلب النماذج: ' + error.message);
      renderTable([]);
    }
  }

  function hidePdfViewer() {
    const iframe = document.getElementById('pdfViewer');
    iframe.style.display = 'none';
    iframe.src = '';
  }

  // معالج حدث لزر "عرض" فقط
  document.querySelector('#modelsTable tbody').addEventListener('click', async (e) => {
    const id = Number(e.target.dataset.id);
    if (!id) return;

    if (e.target.classList.contains('viewBtn')) {
      try {
        const allModels = await getAllModels();
        const model = allModels.find(m => m.id === id);

        if (model && model.fileBlob instanceof Blob) {
          const iframe = document.getElementById('pdfViewer');
          const url = URL.createObjectURL(model.fileBlob);
          iframe.src = url;
          iframe.style.display = 'block';
          iframe.onload = () => URL.revokeObjectURL(url);
          iframe.scrollIntoView({ behavior: "smooth" });
        } else {
          alert('الملف غير متوفر أو غير صالح للعرض.');
          hidePdfViewer();
        }
      } catch (error) {
        console.error('Error viewing PDF:', error);
        alert('حدث خطأ أثناء عرض الملف: ' + error.message);
        hidePdfViewer();
      }
    }
  });

  // أحداث الأزرار وادخال البحث
  document.getElementById('searchBtn').addEventListener('click', () => {
    searchAndRender();
  });

  document.getElementById('filterKeyword').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      searchAndRender();
    }
  });

  // تحديث التاريخ والوقت كل ثانية
  function updateDateTime() {
    const dateTimeDiv = document.getElementById('dateTime');
    const now = new Date();

    const optionsDate = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
    const optionsTime = { hour: '2-digit', minute: '2-digit', second: '2-digit' };

    const formattedDate = now.toLocaleDateString('ar-EG', optionsDate);
    const formattedTime = now.toLocaleTimeString('ar-EG', optionsTime);

    dateTimeDiv.textContent = `${formattedDate} - ${formattedTime}`;
  }

  // Initialize: Open DB and then render all models initially
  openDB().then(() => {
    // Optionally, uncomment the next line to show all models when the page loads
    // searchAndRender();
  }).catch(err => {
    console.error('Error opening database in user page:', err);
    alert('تعذر فتح قاعدة البيانات: ' + err.message);
  });

  setInterval(updateDateTime, 1000);
  updateDateTime();

  // Initial render with no results until search is performed or page loads all
  renderTable([]);
</script>
</body>
</html>