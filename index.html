<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø¯ÙŠØ± - Ø¥Ø¯Ø§Ø±Ø© Ù†Ù…Ø§Ø°Ø¬ PDF</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f0f4f8;
      margin: 0; padding: 0;
      direction: rtl;
    }
    header {
      background: #1e3a8a;
      padding: 15px 20px;
      color: white;
      text-align: center;
      font-size: 24px;
      line-height: 1.2;
    }
    header div {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 5px;
    }
    main {
      max-width: 900px;
      margin: 30px auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px #ccc;
    }
    label {
      display: block;
      margin: 10px 0 5px;
    }
    input[type=text], input[type=file] {
      width: 100%;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }
    button {
      margin-top: 15px;
      background-color: #2563eb;
      color: white;
      border: none;
      padding: 12px 25px;
      font-size: 16px;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    button:hover {
      background-color: #1e40af;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 25px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 12px;
      text-align: center;
    }
    th {
      background-color: #e5e7eb;
    }
    .message {
      margin-top: 15px;
      padding: 12px;
      border-radius: 6px;
    }
    .success {
      background-color: #d1fae5;
      color: #065f46;
    }
    .error {
      background-color: #fee2e2;
      color: #991b1b;
    }
    nav {
      text-align: center;
      margin-bottom: 20px;
    }
    nav a {
      color: #1e3a8a;
      text-decoration: none;
      font-weight: bold;
      font-size: 18px;
      border: 2px solid #1e3a8a;
      padding: 6px 12px;
      border-radius: 6px;
      transition: background-color 0.3s, color 0.3s;
    }
    nav a:hover {
      background-color: #1e3a8a;
      color: white;
    }
    input.edit-input {
      width: 90%;
      padding: 6px;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    #pdfViewer {
      display: none;
      width: 100%;
      height: 600px;
      margin-top: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px #aaa;
    }
    .action-button {
      width: 80px;
      height: 40px;
      font-size: 14px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      transition: background-color 0.3s;
      color: white;
    }
    .viewBtn {
      background-color: #2563eb;
    }
    .viewBtn:hover {
      background-color: #1e40af;
    }
    .deleteBtn {
      background-color: #dc2626;
    }
    .deleteBtn:hover {
      background-color: #991b1b;
    }
    #counter {
      margin-top: 10px;
      font-size: 18px;
      font-weight: bold;
      color: #1e3a8a;
    }
  </style>
</head>
<body>
<header>
  <div>Ù…Ø¯ÙŠØ±ÙŠØ© ØµØ­Ø© Ù…Ø­Ø§ÙØ¸Ø© Ù…Ø§Ø¯Ø¨Ø§</div>
  Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø¯ÙŠØ± - Ø¥Ø¯Ø§Ø±Ø© Ù†Ù…Ø§Ø°Ø¬ PDF
</header>
<main>
<nav>
  <a href="user.html">ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ¹Ù„Ù… ğŸ”</a>
</nav>
<section id="uploadSection">
  <h2>Ø¥Ø¶Ø§ÙØ© Ù†Ù…ÙˆØ°Ø¬ Ø¬Ø¯ÙŠØ¯</h2>
  <form id="uploadForm">
    <label for="name">Ø§Ø³Ù… Ø§Ù„Ù†Ù…ÙˆØ°Ø¬</label>
    <input type="text" id="name" required />
    <label for="pdfFile">Ø§Ø®ØªØ± Ù…Ù„Ù PDF</label>
    <input type="file" id="pdfFile" accept="application/pdf" required />
    <button type="submit">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù†Ù…ÙˆØ°Ø¬</button>
  </form>
  <div id="message" class="message" style="display:none;"></div>
</section>
<hr />
<section id="manageSection">
  <h2>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù†Ù…Ø§Ø°Ø¬</h2>
  <div id="counter">Ø¹Ø¯Ø¯ Ø§Ù„Ù†Ù…Ø§Ø°Ø¬: 0</div>
  <table id="modelsTable">
    <thead>
      <tr>
        <th>Ø§Ø³Ù… Ø§Ù„Ù†Ù…ÙˆØ°Ø¬</th>
        <th>Ø§Ù„Ù…Ù„Ù</th>
        <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <iframe id="pdfViewer"></iframe>
</section>
</main>

<script async defer src="https://apis.google.com/js/api.js"></script>
<script src="https://accounts.google.com/gsi/client"></script>

<script>
  // Ù„Ù… Ù†Ø¹Ø¯ Ø¨Ø­Ø§Ø¬Ø© Ø¥Ù„Ù‰ IndexedDB Ù„ØªØ®Ø²ÙŠÙ† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù„ÙØ§ØªØŒ ÙÙ‚Ø· Ù„ØªØ®Ø²ÙŠÙ† Ù…Ø¤Ù‚Øª Ø¥Ø°Ø§ Ø£Ø±Ø¯Øª
  // ÙˆÙ„ÙƒÙ† Ù…Ù† Ø§Ù„Ø£ÙØ¶Ù„ Ø¬Ù„Ø¨ ÙƒÙ„ Ø´ÙŠØ¡ Ù…Ù† Ø¯Ø±Ø§ÙŠÙ Ù…Ø¨Ø§Ø´Ø±Ø© Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©.
  // Ø³Ù†Ù‚ÙˆÙ… Ø¨Ø¥Ø¨Ù‚Ø§Ø¡ ØªØ¹Ø±ÙŠÙØ§Øª IndexedDB Ù‡Ù†Ø§ Ù„ÙƒÙ† Ù„Ù† Ù†Ø³ØªØ®Ø¯Ù…Ù‡Ø§ Ù„Ø¬Ù„Ø¨ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù†Ù…Ø§Ø°Ø¬.
  const DB_NAME = 'PDFModelsDB';
  const DB_VERSION = 1;
  const STORE_NAME = 'models';
  let db; // Ø³ØªØ¨Ù‚Ù‰ ØºÙŠØ± Ù…Ø³ØªØ®Ø¯Ù…Ø© ÙØ¹Ù„ÙŠØ§Ù‹ Ù„Ø¬Ù„Ø¨ Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ØŒ ÙÙ‚Ø· Ù„Ù„Ø­ÙØ¸ Ø¹Ù†Ø¯ Ø§Ù„Ø±ÙØ¹.

  // Google API & GIS configuration
  const CLIENT_ID = '877200657875-b5qcv791tdespl57eof12tfl92q01hbm.apps.googleusercontent.com'; 
  const SCOPES = 'https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/drive.metadata.readonly'; // Ø£Ø¶ÙÙ†Ø§ read-only scope
  
  const DESTINATION_FOLDER_ID = '1pr2L9RzJ5kI5ybA94EOZYuy1WFtoia-8'; 

  let gapiInited = false;
  let gisInited = false;
  let tokenClient; 

  function handleClientLoad() {
    gapi.load('client', intializeGapiClient);
    google.accounts.id.initialize({
      client_id: CLIENT_ID,
      callback: () => {}, 
    });
    if (typeof google !== 'undefined' && google.accounts && google.accounts.oauth2) {
      onLoadGis();
    } else {
      console.log('Waiting for google.accounts.oauth2 to load...');
      setTimeout(handleClientLoad, 200); 
    }
  }

  async function intializeGapiClient() {
    await gapi.client.init({
      discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
    });
    gapiInited = true;
    console.log('gapi client initialized');
    // Ù„Ø§ Ø¯Ø§Ø¹ÙŠ Ù„ÙØªØ­ DB Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù„Ø£Ù†Ù†Ø§ Ø³Ù†Ù‚Ø±Ø£ Ù…Ù† Ø¯Ø±Ø§ÙŠÙ Ù…Ø¨Ø§Ø´Ø±Ø©
    renderTable(); // Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù…Ø¨Ø§Ø´Ø±Ø© Ø¨Ø¹Ø¯ ØªÙ‡ÙŠØ¦Ø© GAPI
  }

  function onLoadGis() {
    tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: CLIENT_ID,
      scope: SCOPES,
      callback: '', 
    });
    gisInited = true;
    console.log('GIS client initialized');
  }

  window.onload = handleClientLoad; 

  // IndexedDB Functions (ØªÙ… Ø¥Ø¨Ù‚Ø§Ø¤Ù‡Ø§ Ø¥Ø°Ø§ Ø£Ø±Ø¯Øª Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡Ø§ Ù„Ø£ØºØ±Ø§Ø¶ Ø£Ø®Ø±Ù‰ØŒ Ù„ÙƒÙ† Ù„ÙŠØ³Øª Ù„Ø¬Ù„Ø¨ Ø§Ù„Ù†Ù…Ø§Ø°Ø¬)
  function openDB() {
    return new Promise((resolve, reject) => {
      const request = indexedDB.open(DB_NAME, DB_VERSION);
      request.onupgradeneeded = event => {
        const db = event.target.result;
        if (!db.objectStoreNames.contains(STORE_NAME)) {
          const store = db.createObjectStore(STORE_NAME, { keyPath: 'id' }); 
          store.createIndex('name', 'name', { unique: false });
          store.createIndex('googleDriveFileId', 'googleDriveFileId', { unique: true });
        }
      };
      request.onsuccess = event => {
        db = event.target.result;
        resolve(db);
      };
      request.onerror = event => {
        reject(event.target.error);
      };
    });
  }

  function saveModelToIndexedDB(model) {
    return new Promise((resolve, reject) => {
      if (!db) { // Ø§ÙØªØ­ DB Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙØªÙˆØ­Ø© (Ù„Ù„ØªØ£ÙƒØ¯ ÙÙ‚Ø·)
        openDB().then(() => {
          const tx = db.transaction(STORE_NAME, 'readwrite');
          const store = tx.objectStore(STORE_NAME);
          const request = store.put(model);
          request.onsuccess = () => resolve();
          request.onerror = e => reject(e.target.error);
        }).catch(err => reject(err));
      } else {
        const tx = db.transaction(STORE_NAME, 'readwrite');
        const store = tx.objectStore(STORE_NAME);
        const request = store.put(model);
        request.onsuccess = () => resolve();
        request.onerror = e => reject(e.target.error);
      }
    });
  }

  function deleteModelFromIndexedDB(id) {
    return new Promise((resolve, reject) => {
      if (!db) { reject('IndexedDB not open'); return; }
      const tx = db.transaction(STORE_NAME, 'readwrite');
      const store = tx.objectStore(STORE_NAME);
      const request = store.delete(id);
      request.onsuccess = () => resolve();
      request.onerror = e => reject(e.target.error);
    });
  }

  // Ù‡Ø°Ù‡ Ø§Ù„ÙˆØ¸ÙŠÙØ© ØªÙ… ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§ Ù„Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù„ÙØ§Øª Ù…Ù† Google Drive
  async function getAllModelsFromDrive() {
    try {
      await authenticate(); // ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ù‚Ø¨Ù„ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù„ÙØ§Øª

      const response = await gapi.client.drive.files.list({
        q: `'${DESTINATION_FOLDER_ID}' in parents and mimeType='application/pdf' and trashed=false`,
        fields: 'files(id, name, createdTime)', // Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø¹Ø±Ù ÙˆØ§Ù„Ø§Ø³Ù… ÙˆÙˆÙ‚Øª Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡
        pageSize: 100 // ÙŠÙ…ÙƒÙ† Ø²ÙŠØ§Ø¯Ø© Ù‡Ø°Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù„Ø¯ÙŠÙƒ Ø§Ù„ÙƒØ«ÙŠØ± Ù…Ù† Ø§Ù„Ù…Ù„ÙØ§Øª
      });

      const files = response.result.files;
      // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª Ø¥Ù„Ù‰ ØªÙ†Ø³ÙŠÙ‚ ÙŠØªÙ†Ø§Ø³Ø¨ Ù…Ø¹ Ù…Ø§ ÙƒÙ†Ø§ Ù†Ø³ØªØ®Ø¯Ù…Ù‡ Ø³Ø§Ø¨Ù‚Ù‹Ø§
      // ID Ù„Ù„Ù…Ù„Ù Ù‡Ùˆ googleDriveFileIdØŒ ÙˆØ§Ø³Ù…Ù‡ Ù‡Ùˆ name
      return files.map(file => ({
        id: file.createdTime ? new Date(file.createdTime).getTime() : Date.now(), // Ø§Ø³ØªØ®Ø¯Ù… ÙˆÙ‚Øª Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡ ÙƒÙ€ ID Ù…Ø¤Ù‚Øª
        name: file.name.replace(/\.pdf$/i, ''), // Ø¥Ø²Ø§Ù„Ø© Ø§Ù…ØªØ¯Ø§Ø¯ .pdf Ù…Ù† Ø§Ù„Ø§Ø³Ù…
        googleDriveFileId: file.id
      }));
    } catch (error) {
      console.error('Error fetching files from Google Drive:', error);
      showMessage('Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù„ÙØ§Øª Ù…Ù† Google Drive: ' + (error.result?.error?.message || error.message), true);
      return []; // Ø¥Ø±Ø¬Ø§Ø¹ Ù…ØµÙÙˆÙØ© ÙØ§Ø±ØºØ© ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£
    }
  }

  // Helper functions
  function showMessage(text, isError = false) {
    const msgDiv = document.getElementById('message');
    msgDiv.style.display = 'block';
    msgDiv.textContent = text;
    msgDiv.className = isError ? 'message error' : 'message success';
    setTimeout(() => msgDiv.style.display = 'none', 4000);
  }

  function escapeHtml(text) {
    return text.replace(/[&<>"']/g, m => ({
      '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
    })[m]);
  }

  // Authentication function
  async function authenticate() {
    return new Promise((resolve, reject) => {
      if (!gapiInited || !gisInited) {
        console.error('Google API client or GIS not loaded yet. Retrying in 1 second...');
        setTimeout(() => authenticate().then(resolve).catch(reject), 1000); 
        return;
      }

      tokenClient.callback = (resp) => {
        if (resp.error) {
          console.error('Authentication error:', resp.error);
          showMessage('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©: ' + (resp.error.details || resp.error), true);
          reject(resp.error);
        } else {
          console.log('Authentication successful:', resp);
          resolve();
        }
      };

      const token = gapi.client.getToken();
      if (token === null || token.expires_at < Date.now() + 60000) { 
        console.log('Requesting new access token...');
        tokenClient.requestAccessToken({ prompt: 'consent' }); 
      } else {
        console.log('Using existing access token.');
        resolve();
      }
    });
  }


  // Render Table (ØªÙ… ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… getAllModelsFromDrive)
  async function renderTable() {
    const models = await getAllModelsFromDrive(); // Ø¬Ù„Ø¨ Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ Ù…Ù† Ø¯Ø±Ø§ÙŠÙ
    const tbody = document.querySelector('#modelsTable tbody');
    tbody.innerHTML = '';
    document.getElementById('counter').textContent = `Ø¹Ø¯Ø¯ Ø§Ù„Ù†Ù…Ø§Ø°Ø¬: ${models.length}`;
    if (models.length === 0) {
      tbody.innerHTML = `<tr><td colspan="3">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†Ù…Ø§Ø°Ø¬ Ù…Ø¶Ø§ÙØ© Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.</td></tr>`;
      document.getElementById('pdfViewer').style.display = 'none';
      return;
    }
    models.forEach(model => {
      const tr = document.createElement('tr');
      // Passed googleDriveFileId to data-googledriveid for view and delete actions
      tr.innerHTML = `
        <td><input type="text" class="edit-input" data-id="${model.id}" data-field="name" value="${escapeHtml(model.name)}" /></td>
        <td><button class="action-button viewBtn" data-id="${model.id}" data-googledriveid="${model.googleDriveFileId || ''}">Ø¹Ø±Ø¶</button></td>
        <td><button class="action-button deleteBtn" data-id="${model.id}" data-googledriveid="${model.googleDriveFileId || ''}">Ø­Ø°Ù</button></td>
      `;
      tbody.appendChild(tr);
    });
  }

  // Upload Form Event Listener
  document.getElementById('uploadForm').addEventListener('submit', async e => {
    e.preventDefault();
    const nameInput = document.getElementById('name');
    const fileInput = document.getElementById('pdfFile');
    let name = nameInput.value.trim(); // Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù Ù…Ù† Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
    const file = fileInput.files[0];

    if (!name) { showMessage('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù†Ù…ÙˆØ°Ø¬.', true); return; }
    if (!file || file.type !== 'application/pdf') { showMessage('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù PDF ØµØ§Ù„Ø­.', true); return; }

    // Ø¥Ø¶Ø§ÙØ© Ø§Ù…ØªØ¯Ø§Ø¯ .pdf Ø¥Ù„Ù‰ Ø§Ù„Ø§Ø³Ù… Ù„ÙŠØ¸Ù‡Ø± ÙÙŠ Ø¬ÙˆØ¬Ù„ Ø¯Ø±Ø§ÙŠÙ
    if (!name.endsWith('.pdf') && !name.endsWith('.PDF')) {
        name += '.pdf';
    }

    try {
      await authenticate(); 

      const formData = new FormData();
      const metadata = {
        name: name,
        mimeType: 'application/pdf',
        parents: [DESTINATION_FOLDER_ID] 
      };
      formData.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
      formData.append('file', file);

      const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
        method: 'POST',
        headers: new Headers({
          'Authorization': 'Bearer ' + gapi.client.getToken().access_token
        }),
        body: formData
      });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(`ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù Ø¥Ù„Ù‰ Google Drive: ${errorData.error.message || response.statusText}`);
      }

      const fileMetadata = await response.json();
      console.log('File uploaded to Google Drive:', fileMetadata);

      // Ù‡Ù†Ø§ Ù†Ù‚ÙˆÙ… Ø¨Ø­ÙØ¸ ID Ø§Ù„Ù…Ù„Ù ÙÙ‚Ø· Ø¥Ù„Ù‰ IndexedDB (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
      // Ù‚Ø¯ Ù„Ø§ ØªØ­ØªØ§Ø¬ Ù„Ø­ÙØ¸ Ù‡Ø°Ø§ ÙÙŠ IndexedDB Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø·Ù„Ø§Ù‚ Ø¥Ø°Ø§ ÙƒÙ†Øª ØªØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Google Drive Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
      // ÙˆÙ„ÙƒÙ† Ø³Ù†Ø¨Ù‚ÙŠÙ‡ ÙƒÙ€ Ù†Ù…ÙˆØ°Ø¬ Ø¨Ø³ÙŠØ·
      const model = { 
        id: fileMetadata.id, // Ø§Ø³ØªØ®Ø¯Ø§Ù… Drive ID ÙƒÙ€ ID Ø£Ø³Ø§Ø³ÙŠ
        name: fileMetadata.name.replace(/\.pdf$/i, ''), // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø§Ù…ØªØ¯Ø§Ø¯ Ù…Ù† Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶
        googleDriveFileId: fileMetadata.id 
      };
      // Ø¥Ø°Ø§ ÙƒÙ†Øª Ù„Ø§ ØªØ±ÙŠØ¯ ØªØ®Ø²ÙŠÙ† ÙÙŠ IndexedDB Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø·Ù„Ø§Ù‚ØŒ ÙŠÙ…ÙƒÙ†Ùƒ Ø­Ø°Ù Ø§Ù„Ø³Ø·Ø± Ø§Ù„ØªØ§Ù„ÙŠ
      // await saveModelToIndexedDB(model); 
      
      showMessage('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ ÙˆØ±ÙØ¹Ù‡ Ø¨Ù†Ø¬Ø§Ø­.');
      e.target.reset();
      await renderTable(); // Ø¥Ø¹Ø§Ø¯Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¨Ø¹Ø¯ Ø§Ù„Ø±ÙØ¹ Ù„ÙŠØ±Ù‰ Ø§Ù„ØªØºÙŠÙŠØ±
    } catch (err) {
      showMessage('Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù Ø£Ùˆ Ø§Ù„Ø­ÙØ¸: ' + err.message || err, true);
      console.error('Upload/Save error:', err);
    }
  });

  // Edit Name (ØªÙ… ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§ Ù„ØªØ­Ø¯ÙŠØ« Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù ÙÙŠ Google Drive)
  document.querySelector('#modelsTable tbody').addEventListener('change', async e => {
    if (e.target.classList.contains('edit-input')) {
      const googleDriveFileId = e.target.dataset.googledriveid; // Get Drive File ID
      let newName = e.target.value.trim();

      if (!googleDriveFileId) {
        showMessage('Ø®Ø·Ø£: Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø¹Ø±Ù Ù…Ù„Ù Ø¬ÙˆØ¬Ù„ Ø¯Ø±Ø§ÙŠÙ Ù„Ù‡Ø°Ø§ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬.', true);
        return;
      }
      if (!newName) {
        showMessage('Ø§Ø³Ù… Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙƒÙˆÙ† ÙØ§Ø±ØºØ§Ù‹.', true);
        renderTable(); // Ø£Ø¹Ø¯ Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
        return;
      }

      // Ø£Ø¶Ù Ø§Ù…ØªØ¯Ø§Ø¯ .pdf Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ù„Ù„Ø§Ø³Ù… Ù‚Ø¨Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ« ÙÙŠ Ø¯Ø±Ø§ÙŠÙ
      if (!newName.endsWith('.pdf') && !newName.endsWith('.PDF')) {
          newName += '.pdf';
      }

      try {
        await authenticate(); // ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©

        const response = await gapi.client.drive.files.update({
          fileId: googleDriveFileId,
          resource: {
            name: newName
          },
          fields: 'id,name' // Ø§Ø·Ù„Ø¨ ÙÙ‚Ø· Ø§Ù„Ù…Ø¹Ø±Ù ÙˆØ§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø­Ø¯Ø«
        });

        if (response.status === 200) {
          showMessage('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ø³Ù… Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ ÙÙŠ Google Drive.');
          await renderTable(); // Ø£Ø¹Ø¯ Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø§Ø³Ù…
        } else {
          throw new Error('ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù ÙÙŠ Google Drive: ' + response.statusText);
        }
      } catch (err) {
        showMessage('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø§Ø³Ù…: ' + err.message || err, true);
        console.error('Rename error:', err);
        renderTable(); // Ø£Ø¹Ø¯ Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
      }
    }
  });

  // Delete and View Buttons Event Listener
  document.querySelector('#modelsTable tbody').addEventListener('click', async e => {
    const id = Number(e.target.dataset.id); // Ù‡Ø°Ø§ ID Ø³ÙŠÙƒÙˆÙ† ÙˆÙ‚Øª Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¢Ù†
    const googleDriveFileId = e.target.dataset.googledriveid; // Ù‡Ø°Ø§ Ù‡Ùˆ ID Ø§Ù„Ù…Ù‡Ù… Ù„Ø¯Ø±Ø§ÙŠÙ

    if (e.target.classList.contains('deleteBtn')) {
      if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ØŸ Ø³ÙŠØªÙ… Ø­Ø°ÙÙ‡ Ø£ÙŠØ¶Ø§Ù‹ Ù…Ù† Google Drive.')) {
        try {
          await authenticate(); // Authenticate before deleting from Drive

          if (googleDriveFileId) {
            const response = await fetch(`https://www.googleapis.com/drive/v3/files/${googleDriveFileId}`, {
              method: 'DELETE',
              headers: new Headers({
                'Authorization': 'Bearer ' + gapi.client.getToken().access_token
              })
            });

            if (!response.ok) {
              const errorData = await response.json();
              throw new Error(`ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ù…Ù„Ù Ù…Ù† Google Drive: ${errorData.error.message || response.statusText}`);
            }
            console.log('File deleted from Google Drive:', googleDriveFileId);
          }

          // Ù„Ø§ Ø¯Ø§Ø¹ÙŠ Ù„Ø­Ø°ÙÙ‡ Ù…Ù† IndexedDB Ø¥Ø°Ø§ ÙƒÙ†Ø§ Ù„Ø§ Ù†Ø¹ØªÙ…Ø¯ Ø¹Ù„ÙŠÙ‡Ø§ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©
          // ÙˆÙ„ÙƒÙ† ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¨Ù‚Ø§Ø¡ Ø§Ù„Ø³Ø·Ø± Ø§Ù„ØªØ§Ù„ÙŠ Ø¥Ø°Ø§ ÙƒÙ†Øª ØªØ³ØªØ®Ø¯Ù… IndexedDB Ù„Ø£ØºØ±Ø§Ø¶ Ø£Ø®Ø±Ù‰
          // await deleteModelFromIndexedDB(id); 

          showMessage('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø¨Ù†Ø¬Ø§Ø­.');
          await renderTable(); // Re-render table to show the new model
          document.getElementById('pdfViewer').style.display = 'none'; // Hide viewer if open
        } catch (err) {
          showMessage('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù: ' + err.message || err, true);
          console.error('Delete error:', err);
        }
      }
    }

    if (e.target.classList.contains('viewBtn')) {
      if (!googleDriveFileId) {
        showMessage('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø¹Ø±Ù Ù…Ù„Ù Ø¬ÙˆØ¬Ù„ Ø¯Ø±Ø§ÙŠÙ Ù„Ù‡Ø°Ø§ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬.', true);
        return;
      }
      try {
        await authenticate(); 

        const iframe = document.getElementById('pdfViewer');
        const accessToken = gapi.client.getToken().access_token;
        if (!accessToken) {
          showMessage('Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø±Ù…Ø² Ø§Ù„ÙˆØµÙˆÙ„. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©.', true);
          return;
        }
        // Ø§Ø³ØªØ®Ø¯Ø§Ù… Google Docs Viewer Ù…Ø¹ Ø±Ù…Ø² Ø§Ù„ÙˆØµÙˆÙ„
        iframe.src = `https://docs.google.com/viewer?url=https://www.googleapis.com/drive/v3/files/${googleDriveFileId}?alt=media&access_token=${accessToken}&embedded=true`;
        iframe.style.display = 'block';
        iframe.scrollIntoView({ behavior: "smooth" });
        showMessage('ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ù„Ù„Ø¹Ø±Ø¶...');

      } catch (err) {
        showMessage('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ù…Ù† Ø¬ÙˆØ¬Ù„ Ø¯Ø±Ø§ÙŠÙ: ' + err.message || err, true);
        console.error('View error:', err);
      }
    }
  });

</script>
</body>
</html>
